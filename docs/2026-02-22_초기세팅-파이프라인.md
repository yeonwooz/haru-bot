# 2026-02-22: 초기 세팅 + 파이프라인 구현

## 환경 세팅
- `.env.example`, `.gitignore` 정비 (diary_log.json, usage_log.csv 제외)
- uv 프로젝트로 전환 (`pyproject.toml`, Python 3.12 고정)
  - Python 3.14는 python-telegram-bot과 호환 문제 있어서 3.12 사용
- Telegram Bot 연동: BotFather로 봇 생성, Chat ID 확인, 메시지 전송 테스트 완료
- Notion 일기 DB 생성 및 Integration 연결
  - DB 속성: `summary` (Title), `date` (Date), `comment` (Rich text)

## 파이프라인 구조 변경

### 기존 (blocking 방식)
수집 → 요약 → 전송 → **답장 무제한 대기** → 저장

### 변경 후 (2단계 답장 처리)
1. **미처리 답장 확인** — 이전 실행 이후 온 텔레그램 메시지를 모아서 Notion 업데이트
2. 데이터 수집 (Calendar, Notion)
3. Claude 요약 생성
4. Telegram 전송
5. 오늘 일기 Notion 저장 (코멘트 없이)
6. **답장 대기 (최대 5분)** — 오면 바로 Notion 업데이트, 안 오면 다음 실행에서 처리

### 답장 소비 로직
- 1단계에서 미처리 답장을 `consume=False`로 확인만 함
- 어제 일기가 있으면 저장 후 소비, 없으면 소비하지 않음
- 소비되지 않은 답장은 6단계에서 오늘 일기에 반영

### 장점
- 상시 서버 불필요 (GitHub Actions 스케줄로 운영 가능)
- 대부분 당일 반영, 늦게 답해도 다음 날 처리

## GitHub Actions
- `.github/workflows/daily.yml`: 매일 오후 8시 KST (UTC 11:00) 자동 실행
- `workflow_dispatch`로 수동 실행 가능
- `timeout-minutes: 15` (답장 대기 5분 + 여유)
- 모든 API 키는 GitHub Secrets에 등록

## 주요 코드 변경
- `src/diary_store.py` 신규: Notion DB에 일기 저장 + 코멘트 업데이트
- `src/telegram_bot.py`: `get_latest_reply(consume)` 추가 (미확인 메시지 전부 합쳐서 반환, 소비 제어)
- `src/main.py`: KST 기준 날짜 처리, 새 파이프라인 흐름
- `config.py`: `TELEGRAM_REPLY_TIMEOUT = 300` (5분)

## 이슈
- notion-client 3.x에서 `databases.query()` 제거됨 → `client.search()`로 우회
- Python 3.14는 typing 모듈 변경으로 python-telegram-bot 호환 안 됨 → 3.12 고정
- 레포 public으로 전환 완료 (코드에 민감 정보 없음, API 키는 Secrets 관리)
